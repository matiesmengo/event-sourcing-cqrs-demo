@startuml
title System Architecture - Event-Source + CQRS + SAGA Demo
!theme plain

' ========= GLOBAL STYLING =========
skinparam backgroundColor #FFFFFF
skinparam defaultFontName "Inter, Segoe UI, Helvetica"
skinparam defaultFontColor #2C3E50
skinparam shadowing false
skinparam arrowThickness 1.2
skinparam arrowColor #555555

skinparam rectangle {
    FontSize 14
    RoundCorner 15
    BorderColor #CCCCCC
    BackgroundColor #FAFAFA
}
skinparam database {
    BackgroundColor #EAF4F9
    BorderColor #9CC3D5
}
skinparam node {
    BackgroundColor #F8F9FA
    BorderColor #BBBBBB
}
skinparam component {
    BackgroundColor #F8F9FA
    BorderColor #BBBBBB
}
skinparam actorStyle awesome

' ========= ACTOR =========
actor "User" as user #4F81BD

' ========= SERVICE CONTEXTS =========
rectangle "<b>Booking Context</b>" as booking #EFF6FF {
    node "Booking API" as booking_api
    node "Booking\nCommand" as booking_service_command
    node "Booking\nQuery" as booking_service_query
    database "Booking\nWrite model\nPostgreSQL" as booking_write_db
    database "Booking\nRead model\nMongoDB" as booking_read_db
}

rectangle "<b>Orchestrator Context</b>" as orchestrator #FFF3F3 {
    node "Orchestrator Service" as saga
    database "Orchestrator\nWrite model\nPostgreSQL" as orchestrator_write_db
}

rectangle "<b>Broker</b>" as broker #F8F8F8 {
    node "Kafka Broker" as kafka #FFF4E6
    node "Schema Registry" as registry #FFF9E8
}

rectangle "<b>Product Context</b>" as product #F0FDF4 {
    node "Product Service" as product_service
    database "Product\nWrite model\nPostgreSQL" as product_write_db
}

rectangle "<b>Payment Context</b>" as payment #FDF6EC {
    node "Payment Service" as payment_service
    database "Payment\nWrite model\nPostgreSQL" as payment_write_db
}

' ========= FLOWS =========

' User -> Booking
user --> booking_api
booking_api --> booking_service_command
booking_api --> booking_service_query
booking_service_command --> booking_write_db
booking_service_query --> booking_read_db
kafka <-[#3366CC,dashed]-> booking_service_command
kafka <-[#3366CC,dashed]-> booking_service_query

' Booking & Orchestrator
saga --> orchestrator_write_db
kafka <-[#3366CC,dashed]-> saga

' Product
product_service --> product_write_db
kafka <-[#3366CC,dashed]-> product_service

' Payment
kafka <-[#3366CC,dashed]-> payment_service
payment_service --> payment_write_db

' DataBase
registry  -> kafka : Validate
@enduml
